# Architecture

> Generated by /map on 2026-02-25

## Overview

`yolo-ex` is a small Python CLI package for exporting YOLO `.pt` models through the Ultralytics backend with platform-aware validation.

The project has two user-facing commands:

- `yolo-ex`: validates export arguments, runs platform preflight checks, and executes (or dry-runs) model export
- `yolo-ex-platform`: inspects the current machine/platform and reports package/version compatibility for the Jetson target

The codebase is organized as a `src/` package with focused modules, plus a `tests/` directory with unit tests that heavily mock external imports and platform state.

## System Diagram

```text
User CLI
  |
  +--> yolo-ex (src/yolo_ex/cli.py)
  |       |
  |       +--> models.ExportRequest / ExportFormat
  |       +--> platforms.preflight_for_format()
  |       |       |
  |       |       +--> platform detection (platform module)
  |       |       +--> import checks (importlib.import_module)
  |       |
  |       +--> exporter.export_model()
  |               |
  |               +--> validate_request()
  |               +--> build_export_kwargs()
  |               +--> lazy import ultralytics.YOLO
  |               +--> model.export(...)
  |
  +--> yolo-ex-platform (src/yolo_ex/platform_cli.py)
          |
          +--> platform_check.check_current_platform()
                  |
                  +--> platforms.detect_platform()
                  +--> importlib.metadata.version()
                  +--> importlib.import_module()
                  +--> render_platform_report()
```

## Components

### CLI Export Command
- **Purpose:** Main command entrypoint for `export` operations, argument parsing, logging setup, preflight warnings, and result/error reporting.
- **Location:** `src/yolo_ex/cli.py`
- **Dependencies:** `argparse`, `logging`, `sys`, `pathlib`, `yolo_ex.models`, `yolo_ex.platforms`, `yolo_ex.exporter`, `yolo_ex.errors`, `yolo_ex.logging_utils`
- **Dependents:** `pyproject.toml` console script `yolo-ex`; unit tests in `tests/test_cli.py`

### Export Backend
- **Purpose:** Validates export request fields, builds Ultralytics export kwargs, handles dry-run behavior, and executes Ultralytics export with error wrapping.
- **Location:** `src/yolo_ex/exporter.py`
- **Dependencies:** `importlib`, `json`, `sys`, `pathlib`, lazy `ultralytics.YOLO`, shared models/errors
- **Dependents:** `src/yolo_ex/cli.py`, package public API (`src/yolo_ex/__init__.py`), tests in `tests/test_exporter.py`

### Platform Preflight Rules
- **Purpose:** Detects broad platform target buckets and enforces format-specific module availability before export.
- **Location:** `src/yolo_ex/platforms.py`
- **Dependencies:** `platform`, `importlib`, dataclasses/enums, `yolo_ex.errors`, `yolo_ex.models`
- **Dependents:** `src/yolo_ex/cli.py`, `src/yolo_ex/platform_check.py`, tests in `tests/test_platforms.py`

### Platform Diagnostics / Version Checks
- **Purpose:** Produces a detailed compatibility report for Jetson (Linux arm64), including package presence/import checks and expected versions.
- **Location:** `src/yolo_ex/platform_check.py`
- **Dependencies:** `importlib`, `importlib.metadata`, `platform`, `packaging.version` (optional at runtime), `yolo_ex.platforms`
- **Dependents:** `src/yolo_ex/platform_cli.py`, tests in `tests/test_platform_check.py`

### Platform Check CLI
- **Purpose:** CLI wrapper for running `check_current_platform()` and converting report status to exit codes.
- **Location:** `src/yolo_ex/platform_cli.py`
- **Dependencies:** `argparse`, `yolo_ex.logging_utils`, `yolo_ex.platform_check`
- **Dependents:** `pyproject.toml` console script `yolo-ex-platform`; tests in `tests/test_platform_cli.py`

### Shared Models and Errors
- **Purpose:** Defines core enums/dataclasses (`ExportFormat`, `ExportRequest`, `ExportResult`) and exception hierarchy for CLI/backend coordination.
- **Location:** `src/yolo_ex/models.py`, `src/yolo_ex/errors.py`
- **Dependencies:** stdlib `dataclasses`, `enum`, `pathlib`
- **Dependents:** Most application modules and tests

### Logging Utilities
- **Purpose:** Centralized CLI logging configuration (`INFO`/`DEBUG`).
- **Location:** `src/yolo_ex/logging_utils.py`
- **Dependencies:** stdlib `logging`
- **Dependents:** `src/yolo_ex/cli.py`, `src/yolo_ex/platform_cli.py`

### Tests
- **Purpose:** Unit coverage for CLI parsing/exit codes, exporter validation/execution behavior, platform detection, and platform diagnostics rendering/check logic.
- **Location:** `tests/`
- **Dependencies:** `pytest`, `monkeypatch`, temp paths, stdlib test helpers
- **Dependents:** Developer workflow (`uv run pytest`)

## Data Flow

Export command (`yolo-ex export ...`):

1. CLI parses args into an `ExportRequest`.
2. Logging is configured based on `--verbose`.
3. Jetson preflight runs (`preflight_for_format`) to enforce platform/runtime requirements.
4. Export backend validates request fields and builds Ultralytics kwargs.
5. If `--dry-run`, the backend returns an `ExportResult` with serialized kwargs only.
6. Otherwise, the Ultralytics `YOLO` class is loaded lazily and `model.export(...)` is executed.
7. Backend normalizes the returned export path and wraps failures in `ExportExecutionError`.
8. CLI prints success/error text and returns a process exit code.

Platform diagnostics (`yolo-ex-platform`):

1. CLI runs `check_current_platform()`.
2. Platform target is detected (`jetson` or `other`).
3. Package/version/import checks are executed for the relevant target.
4. A text report is rendered and printed.
5. Exit code reflects unsupported/failed/ok status.

## Integration Points

| External Service / System | Type | Purpose |
|---------------------------|------|---------|
| Ultralytics (`ultralytics.YOLO`) | Python library API | Performs the actual model export |
| Local filesystem (`Path`) | File I/O | Validates source `.pt` model presence and returns output artifact paths |
| Python import system (`importlib`) | Runtime module loading | Preflight/import checks and lazy backend imports |
| Python package metadata (`importlib.metadata`) | Local package metadata | Platform diagnostics version checks |
| OS/platform metadata (`platform`) | System introspection | Detect supported target buckets |
| JetPack/system Python packages (Jetson) | Host runtime dependency | TensorRT and related imports on Linux arm64 |

## Conventions

- **Naming:** Snake_case modules/functions, enum-based format/platform constants, dataclass-based request/result DTOs.
- **Structure:** Thin CLI modules orchestrate shared logic; domain logic lives in `exporter.py`, `platforms.py`, and `platform_check.py`.
- **Error handling:** Custom exceptions (`ExportValidationError`, `ExportExecutionError`) bubble to CLI for stable exit codes/messages.
- **Dependency loading:** Heavy/optional dependencies (e.g., `ultralytics`) are imported lazily to keep dry-run/tests lightweight.
- **Testing:** Pytest unit tests with extensive `monkeypatch` usage to isolate platform/import behavior and avoid real exports.

## Technical Debt

- [ ] `src/yolo_ex/platform_check.py` duplicates expected version constants that also exist in `pyproject.toml` dependency groups, creating drift risk.
- [ ] `tests/` focuses on unit tests/mocking; no integration test verifies a real Ultralytics export or actual platform package imports.
- [ ] `models/` contains large binary model/export artifacts committed to the repo, which increases clone size and churn.
- [ ] Platform support is intentionally narrow (Jetson/Linux arm64 only); unsupported targets return diagnostics but may surprise users expecting broader compatibility.
