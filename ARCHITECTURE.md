# Architecture

> Generated by /map on 2026-02-25

## Overview

`yolo-ex` is a small Python `src/`-layout CLI package for exporting YOLO `.pt` models via Ultralytics to:

- TensorRT `.engine` (Jetson/Linux arm64 target)
- CoreML `.mlpackage` (macOS target)

The codebase is organized around two CLIs:

- `yolo-ex`: export execution (`src/yolo_ex/cli.py`)
- `yolo-ex-platform`: platform/package validation (`src/yolo_ex/platform_cli.py`)

Core responsibilities are split into request models, export backend orchestration, platform preflight checks, and a platform compatibility report generator. Tests are comprehensive and mostly unit-level with monkeypatching/mocking.

## System Diagram

```text
CLI: yolo-ex (src/yolo_ex/cli.py)
  -> parse args (argparse)
  -> configure logging
  -> build ExportRequest
  -> preflight_for_format() [platforms.py]
  -> export_model() [exporter.py]
       -> validate_request()
       -> (engine only) TensorRT module compat shim
       -> ultralytics.YOLO(...).export(...)
  -> print result / error + exit code

CLI: yolo-ex-platform (src/yolo_ex/platform_cli.py)
  -> parse args (argparse)
  -> configure logging
  -> check_current_platform() [platform_check.py]
       -> detect_platform() [platforms.py]
       -> importlib.metadata.version(...)
       -> import checks (torch/torchvision/coremltools/onnxruntime/tensorrt)
  -> render_platform_report()
  -> print report + exit code
```

## Components

### CLI Export Entrypoint
- **Purpose:** User-facing export command (`export` subcommand), request normalization, error-to-exit-code mapping.
- **Location:** `src/yolo_ex/cli.py`
- **Dependencies:** `argparse`, `yolo_ex.models`, `yolo_ex.exporter`, `yolo_ex.platforms`, `yolo_ex.logging_utils`, `yolo_ex.errors`
- **Dependents:** `pyproject.toml` script `yolo-ex`, `tests/test_cli.py`

### Export Backend Wrapper
- **Purpose:** Validate export requests, build Ultralytics kwargs, perform dry-run handling, invoke `ultralytics.YOLO.export`, normalize output path, wrap backend exceptions.
- **Location:** `src/yolo_ex/exporter.py`
- **Dependencies:** `json`, `importlib`, `sys`, `yolo_ex.models`, `yolo_ex.errors`, external `ultralytics`
- **Dependents:** `src/yolo_ex/cli.py`, `src/yolo_ex/__init__.py`, `tests/test_exporter.py`

### Platform Targeting & Preflight
- **Purpose:** Detect target platform bucket and enforce format-specific runtime module requirements before export.
- **Location:** `src/yolo_ex/platforms.py`
- **Dependencies:** `platform`, `importlib`, `yolo_ex.models`, `yolo_ex.errors`
- **Dependents:** `src/yolo_ex/cli.py`, `src/yolo_ex/platform_check.py`, `tests/test_platforms.py`, `tests/test_cli.py`

### Platform Check Engine
- **Purpose:** Validate current environment package metadata/importability for macOS and Jetson targets; render human-readable setup report.
- **Location:** `src/yolo_ex/platform_check.py`
- **Dependencies:** `importlib`, `importlib.metadata`, `warnings`, `logging`, `platform`, `yolo_ex.platforms`
- **Dependents:** `src/yolo_ex/platform_cli.py`, `tests/test_platform_check.py`, `tests/test_platform_cli.py`

### Platform Check CLI Entrypoint
- **Purpose:** Run platform validation and expose status via stdout + process exit code.
- **Location:** `src/yolo_ex/platform_cli.py`
- **Dependencies:** `argparse`, `yolo_ex.platform_check`, `yolo_ex.logging_utils`
- **Dependents:** `pyproject.toml` script `yolo-ex-platform`, `tests/test_platform_cli.py`

### Domain Models
- **Purpose:** Typed request/response structures and export format enum.
- **Location:** `src/yolo_ex/models.py`
- **Dependencies:** `dataclasses`, `enum`, `pathlib`
- **Dependents:** `src/yolo_ex/cli.py`, `src/yolo_ex/exporter.py`, `src/yolo_ex/platforms.py`, tests

### Errors
- **Purpose:** Small exception hierarchy for validation vs execution failures.
- **Location:** `src/yolo_ex/errors.py`
- **Dependencies:** stdlib only
- **Dependents:** `src/yolo_ex/cli.py`, `src/yolo_ex/exporter.py`, `src/yolo_ex/platforms.py`, `src/yolo_ex/__init__.py`, tests

### Logging Utilities
- **Purpose:** Shared CLI logging configuration.
- **Location:** `src/yolo_ex/logging_utils.py`
- **Dependencies:** `logging`
- **Dependents:** `src/yolo_ex/cli.py`, `src/yolo_ex/platform_cli.py`

### Public Package API
- **Purpose:** Re-export stable package API for library-style imports.
- **Location:** `src/yolo_ex/__init__.py`
- **Dependencies:** `yolo_ex.errors`, `yolo_ex.exporter`, `yolo_ex.models`
- **Dependents:** External consumers (potential), package import surface

### Tests
- **Purpose:** Unit coverage for CLIs, exporter behavior, platform preflight, and platform report rendering.
- **Location:** `tests/`
- **Dependencies:** `pytest`, monkeypatch/capsys fixtures
- **Dependents:** CI/local test runs (`uv run pytest`)

### Model Artifacts (Repo Assets)
- **Purpose:** Sample/exported YOLO assets for local experimentation and validation (`.pt`, `.onnx`, `.engine`).
- **Location:** `models/`
- **Dependencies:** N/A (binary assets)
- **Dependents:** Manual runs, CLI demos, local validation workflows

## Data Flow

### Export Flow (`yolo-ex`)
1. CLI parses user input into `argparse.Namespace`.
2. `_request_from_args()` builds a typed `ExportRequest`.
3. `preflight_for_format()` checks platform and required Python modules for selected format.
4. `export_model()` validates file/parameter semantics and assembles Ultralytics kwargs.
5. For TensorRT exports, exporter applies a Jetson compatibility shim (`tensorrt_bindings` -> `tensorrt`) if needed.
6. Ultralytics performs the actual export.
7. CLI prints success/dry-run details or validation/execution errors and returns exit code (`0`, `1`, or `2`).

### Platform Check Flow (`yolo-ex-platform`)
1. CLI triggers `check_current_platform()`.
2. Platform bucket is detected (`macos`, `linux_arm64`, `other`).
3. Package metadata and import checks run against platform-specific baselines.
4. `render_platform_report()` formats a user-facing report and injects Jetson guidance on failure.
5. CLI exits with `0` (all checks OK), `1` (supported but failed checks), or `2` (unsupported platform).

## Integration Points

| External Service / Dependency | Type | Purpose |
|-------------------------------|------|---------|
| Ultralytics (`ultralytics.YOLO`) | Python library / ML backend | Performs actual model export execution |
| TensorRT (`tensorrt`) | Python package + native runtime | Required for Jetson TensorRT engine export and validation |
| `tensorrt_bindings` | Python package variant | Jetson compatibility fallback aliased to `tensorrt` during export |
| CoreMLTools (`coremltools`) | Python library | Required for CoreML export preflight and platform checks |
| PyTorch / TorchVision | Python libraries | Runtime dependencies for export/preflight/platform validation |
| ONNX Runtime GPU (`onnxruntime-gpu`) | Python library | Jetson platform validation target (`onnxruntime` import) |
| `importlib.metadata` | Stdlib metadata API | Reads installed package versions for platform report |
| Local filesystem | OS/filesystem | Reads source `.pt` models and writes exported artifacts |
| Host platform (`platform.system/machine`) | OS API | Detects macOS vs Linux arm64 vs unsupported |

## Conventions

- **Project Layout:** `src/` layout (`src/yolo_ex`) with tests in `tests/` and sample artifacts in `models/`.
- **Entrypoints:** Each CLI module exposes `build_parser()` and `main(argv: Sequence[str] | None) -> int`.
- **Typing:** Strong type hints throughout; `mypy` strict mode is enabled in `pyproject.toml`.
- **Modeling:** Uses `Enum` + `@dataclass(slots=True)` for request/result/report structures.
- **Error Handling:** Domain-specific exceptions (`ExportValidationError`, `ExportExecutionError`) map to distinct CLI exit codes.
- **Side Effects:** Print-based CLI output; heavy imports deferred (e.g., `ultralytics` import inside helper).
- **Testing:** Pytest unit tests with monkeypatching and fixtures; high branch coverage emphasis around platform/runtime edge cases.
- **Packaging:** `uv`/`uv_build` workflow, optional dependency groups for `mac` and `jetson`.

## Technical Debt

- [ ] `src/yolo_ex/platform_check.py` is the largest module (~394 lines) and mixes detection, validation, formatting, and import/version helpers; splitting could reduce maintenance risk.
- [ ] Test coverage is strong at the unit level, but there are no integration/e2e tests that exercise real `ultralytics`, TensorRT, or CoreMLTools environments.
- [ ] `platform_check._versions_match()` relies on `packaging` when available (transitively); the project does not declare `packaging` directly.
