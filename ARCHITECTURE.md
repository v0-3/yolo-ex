# Architecture

> Generated by `codebase-mapper` on 2026-02-24

## Overview

`yolo-ex` is a small Python CLI application for exporting YOLO `.pt` models to platform-targeted formats:

- `coreml` on macOS
- `engine` (TensorRT) on Linux `aarch64` (Jetson-oriented)

It also includes a separate platform validation CLI (`yolo-ex-platform`) that detects the current platform and checks required package versions/import health before export.

The codebase uses a `src/` layout with a thin CLI layer, typed request/result models, an export service wrapper over Ultralytics, and isolated platform/preflight logic.

## System Diagram

```text
uv run yolo-ex export ...
        |
        v
src/yolo_ex/cli.py (argparse)
        |
        | builds ExportRequest
        v
src/yolo_ex/platforms.py (format preflight checks)
        |
        v
src/yolo_ex/exporter.py (validation + kwargs mapping)
        |
        v
ultralytics.YOLO(...).export(...)
        |
        v
filesystem output (.engine / .mlpackage)


uv run yolo-ex-platform
        |
        v
src/yolo_ex/platform_cli.py
        |
        v
src/yolo_ex/platform_check.py
        |
        +--> importlib.metadata version checks
        +--> import checks (coremltools / tensorrt)
        +--> uses src/yolo_ex/platforms.py detect_platform()
```

## Components

### Export CLI

- **Purpose:** Parse export command arguments and orchestrate preflight + export execution.
- **Location:** `src/yolo_ex/cli.py`
- **Dependencies:** `argparse`, `yolo_ex.models`, `yolo_ex.platforms`, `yolo_ex.exporter`, `yolo_ex.logging_utils`, `yolo_ex.errors`
- **Dependents:** Console script `yolo-ex` (via `pyproject.toml`)
- **Notes:** Uses exit codes `0` (success), `1` (execution error), `2` (validation error).

### Export Service

- **Purpose:** Validate `ExportRequest`, map options to Ultralytics export kwargs, run export backend, normalize output path.
- **Location:** `src/yolo_ex/exporter.py`
- **Dependencies:** `yolo_ex.models`, `yolo_ex.errors`, `ultralytics` (runtime import)
- **Dependents:** `src/yolo_ex/cli.py`
- **Notes:** Supports dry-run mode without importing/loading YOLO weights.

### Domain Models

- **Purpose:** Typed request/result contracts for export flows.
- **Location:** `src/yolo_ex/models.py`
- **Dependencies:** stdlib dataclasses/enums/pathlib
- **Dependents:** `cli.py`, `exporter.py`, `platforms.py`, tests
- **Notes:** `ExportFormat` currently supports only `coreml` and `engine`.

### Platform Preflight Checks

- **Purpose:** Detect platform buckets and validate format-specific runtime import availability (`coremltools`, `tensorrt`).
- **Location:** `src/yolo_ex/platforms.py`
- **Dependencies:** `platform`, `importlib`, `yolo_ex.models`, `yolo_ex.errors`
- **Dependents:** `src/yolo_ex/cli.py`, `src/yolo_ex/platform_check.py`, tests
- **Notes:** Warns on platform mismatch but only hard-fails on missing imports.

### Platform Validation Service

- **Purpose:** Detect current platform and verify expected installed package versions/import health for the target environment.
- **Location:** `src/yolo_ex/platform_check.py`
- **Dependencies:** `importlib.metadata`, `importlib`, `platform`, `warnings`, `logging`, `yolo_ex.platforms`
- **Dependents:** `src/yolo_ex/platform_cli.py`, tests
- **Notes:** Checks macOS and Linux arm64 (Jetson-oriented) dependency sets; suppresses noisy `coremltools` torch-compat warning during import probe.

### Platform Validation CLI

- **Purpose:** Run platform checks and print a human-readable report.
- **Location:** `src/yolo_ex/platform_cli.py`
- **Dependencies:** `argparse`, `yolo_ex.logging_utils`, `yolo_ex.platform_check`
- **Dependents:** Console script `yolo-ex-platform` (via `pyproject.toml`)
- **Notes:** Exit codes `0` (pass), `1` (supported platform but failed checks), `2` (unsupported platform).

### Shared Errors and Logging

- **Purpose:** Centralized exception types and minimal logging configuration.
- **Location:** `src/yolo_ex/errors.py`, `src/yolo_ex/logging_utils.py`
- **Dependencies:** stdlib only
- **Dependents:** All CLI/service modules

### Public Package API

- **Purpose:** Re-export key types and export function.
- **Location:** `src/yolo_ex/__init__.py`
- **Dependencies:** `yolo_ex.errors`, `yolo_ex.exporter`, `yolo_ex.models`
- **Dependents:** External Python consumers (optional use)

## Data Flow

### Export Command (`yolo-ex export`)

1. CLI parses arguments into an `argparse.Namespace`.
2. CLI converts args to `ExportRequest`.
3. CLI runs `preflight_for_format()` to validate runtime imports and gather warnings.
4. CLI calls `export_model(request)`.
5. Export service validates file path/extension and option combinations.
6. Export service builds Ultralytics kwargs (format-specific filtering).
7. Export service either:
   - returns a synthetic `ExportResult` for `dry_run`, or
   - runs `ultralytics.YOLO(...).export(...)`.
8. CLI prints success/dry-run output and exits with status code.

### Platform Check Command (`yolo-ex-platform`)

1. CLI parses optional `--verbose`.
2. `check_current_platform()` detects platform bucket via `detect_platform()`.
3. Service runs package metadata checks and import checks for the detected platform.
4. `render_platform_report()` converts the report to human-readable lines.
5. CLI prints report and exits based on report outcome.

## Integration Points

| External Service | Type | Purpose |
|------------------|------|---------|
| Local filesystem | Filesystem | Read `.pt` input; write exported model artifacts |
| `ultralytics` Python package | Library | YOLO model loading and export backend |
| `coremltools` Python package | Library | CoreML export runtime dependency on macOS |
| `tensorrt` / `tensorrt-cu12-bindings` | Library | TensorRT export runtime dependency on Jetson/Linux arm64 |
| NVIDIA PyPI (`pypi.nvidia.com`) | Package index | Jetson TensorRT bindings resolution during `uv sync` |
| Ultralytics GitHub release wheels | Direct wheel URLs | Jetson-specific `torch` / `torchvision` installs |

## Conventions

- **Naming:** `snake_case` modules/functions, `PascalCase` dataclasses/enums/exceptions.
- **Structure:** `src/` package layout (`src/yolo_ex`) with parallel `tests/`.
- **CLI Pattern:** Thin `argparse` entrypoints (`cli.py`, `platform_cli.py`) calling focused service modules.
- **Error Handling:** Domain-specific exceptions (`ExportValidationError`, `ExportExecutionError`) translated to exit codes in CLI.
- **Types:** Dataclasses + enums for primary interfaces; `mypy` strict mode is enabled.
- **Testing:** Pytest unit tests with monkeypatch/mocks; no real model exports required in tests.
- **Validation:** `uv`-based checks are used (`ruff`, `pytest`, `mypy`).

## Testing Layout

- `tests/test_cli.py`: export CLI parsing, error codes, dry-run output
- `tests/test_exporter.py`: request validation, kwargs mapping, backend wrapping
- `tests/test_platforms.py`: platform detection and format preflight behavior
- `tests/test_platform_check.py`: package version/import checks and rendering behavior
- `tests/test_platform_cli.py`: platform check CLI exit code and output handling

## Technical Debt

- [ ] Duplicate dependency/version knowledge exists in `pyproject.toml` and `src/yolo_ex/platform_check.py` constants; these can drift.
- [ ] No integration tests cover real Ultralytics export execution on macOS or Jetson hardware.
- [ ] Platform detection treats all Linux `aarch64` as Jetson-oriented and does not verify JetPack/device model.
- [ ] `coremltools` is only presence-checked in `platform_check.py` (not version-pinned), while compatibility may depend on exact versions.
- [ ] `README.md` documents manual Jetson `uv sync --index ...` usage; no automated install profile/script exists for Jetson setup.

